
GRANT ALL ON phet_stats_test_3.* TO "www-data"@localhost IDENTIFIED BY "d3#r3m0nt$";

Before modification: 386 MB total, 82 MB indices
	db_test_report: 333 seconds
	







// get locales
SELECT DISTINCT session.sim_locale_language, session.sim_locale_country FROM session, (SELECT id FROM sim_name WHERE name = 'pendulum-lab') AS x WHERE (session.sim_name = x.id);
// better format
SELECT IF(country IS NULL, language, CONCAT(language, '_', country)) FROM (SELECT DISTINCT session.sim_locale_language AS language, session.sim_locale_country AS country FROM session, (SELECT id FROM sim_name WHERE name = 'pendulum-lab') AS x WHERE (session.sim_name = x.id) ORDER BY session.sim_locale_language, sim_locale_country) as y;

// run count for each locale
SELECT DISTINCT session.sim_locale_language, session.sim_locale_country, COUNT(session.id) FROM session, (SELECT id FROM sim_name WHERE name = 'pendulum-lab') AS x WHERE (session.sim_name = x.id) GROUP BY session.sim_locale_language, sim_locale_country ORDER BY session.sim_locale_language, sim_locale_country;
// better format
SELECT IF(y.country IS NULL, y.language, CONCAT(y.language, '_', y.country)) AS locale, y.counts AS sim_runs FROM (SELECT DISTINCT session.sim_locale_language AS language, session.sim_locale_country AS country, COUNT(session.id) AS counts FROM session, (SELECT id FROM sim_name WHERE name = 'pendulum-lab') AS x WHERE (session.sim_name = x.id) GROUP BY session.sim_locale_language, sim_locale_country ORDER BY session.sim_locale_language, sim_locale_country) as y;







SELECT IF(totals.country IS NULL, totals.language, CONCAT(totals.language, '_', totals.country)) AS locale, totals.val AS total, last_year.val AS last_year, last_month.val AS last_month, last_week.val AS last_week, last_day.val AS last_day
FROM (SELECT DISTINCT session.sim_locale_language AS language, session.sim_locale_country AS country, COUNT(session.id) AS val FROM session, (SELECT id FROM sim_name WHERE name = 'pendulum-lab') AS x WHERE (session.sim_name = x.id) GROUP BY session.sim_locale_language, sim_locale_country ORDER BY session.sim_locale_language, sim_locale_country) as totals, (SELECT DISTINCT session.sim_locale_language AS language, session.sim_locale_country AS country, COUNT(session.id) AS val FROM session, (SELECT id FROM sim_name WHERE name = 'pendulum-lab') AS x WHERE (session.sim_name = x.id AND session.timestamp >= DATE_SUB(CURRENT_TIMESTAMP, INTERVAL 1 YEAR)) GROUP BY session.sim_locale_language, sim_locale_country ORDER BY session.sim_locale_language, sim_locale_country) as last_year, (SELECT DISTINCT session.sim_locale_language AS language, session.sim_locale_country AS country, COUNT(session.id) AS val FROM session, (SELECT id FROM sim_name WHERE name = 'pendulum-lab') AS x WHERE (session.sim_name = x.id AND session.timestamp >= DATE_SUB(CURRENT_TIMESTAMP, INTERVAL 1 MONTH)) GROUP BY session.sim_locale_language, sim_locale_country ORDER BY session.sim_locale_language, sim_locale_country) as last_month, (SELECT DISTINCT session.sim_locale_language AS language, session.sim_locale_country AS country, COUNT(session.id) AS val FROM session, (SELECT id FROM sim_name WHERE name = 'pendulum-lab') AS x WHERE (session.sim_name = x.id AND session.timestamp >= DATE_SUB(CURRENT_TIMESTAMP, INTERVAL 1 WEEK)) GROUP BY session.sim_locale_language, sim_locale_country ORDER BY session.sim_locale_language, sim_locale_country) as last_week, (SELECT DISTINCT session.sim_locale_language AS language, session.sim_locale_country AS country, COUNT(session.id) AS val FROM session, (SELECT id FROM sim_name WHERE name = 'pendulum-lab') AS x WHERE (session.sim_name = x.id AND session.timestamp >= DATE_SUB(CURRENT_TIMESTAMP, INTERVAL 1 DAY)) GROUP BY session.sim_locale_language, sim_locale_country ORDER BY session.sim_locale_language, sim_locale_country) as last_day WHERE (totals.language = last_year.language AND last_year.language = last_month.language AND last_month.language = last_week.language AND last_week.language = last_day.language AND ((totals.country = last_year.country AND last_year.country = last_month.country AND last_month.country = last_week.country AND last_week.country = last_day.country) OR (totals.country IS NULL AND last_year.country IS NULL AND last_month.country IS NULL AND last_week.country IS NULL AND last_day.country IS NULL)));




SELECT CONCAT(totals.sim_major_version, '.', totals.sim_minor_version) AS version, totals.val AS total, last_year.val AS last_year, last_month.val AS last_month, last_week.val AS last_week, last_day.val AS last_day
FROM (
	SELECT DISTINCT session.sim_major_version AS sim_major_version, session.sim_minor_version AS sim_minor_version, COUNT(session.id) AS val
	FROM session, (
		SELECT id FROM sim_name WHERE name = 'pendulum-lab'
	) AS x
	WHERE (session.sim_name = x.id AND session.sim_dev = false)
	GROUP BY session.sim_major_version, sim_minor_version
) as totals,
(
	SELECT DISTINCT session.sim_major_version AS sim_major_version, session.sim_minor_version AS sim_minor_version, COUNT(session.id) AS val
	FROM session, (
		SELECT id FROM sim_name WHERE name = 'pendulum-lab'
	) AS x
	WHERE (session.sim_name = x.id AND session.timestamp >= DATE_SUB(CURRENT_TIMESTAMP, INTERVAL 1 YEAR) AND session.sim_dev = false)
	GROUP BY session.sim_major_version, sim_minor_version
) as last_year,
(
	SELECT DISTINCT session.sim_major_version AS sim_major_version, session.sim_minor_version AS sim_minor_version, COUNT(session.id) AS val
	FROM session, (
		SELECT id FROM sim_name WHERE name = 'pendulum-lab'
	) AS x
	WHERE (session.sim_name = x.id AND session.timestamp >= DATE_SUB(CURRENT_TIMESTAMP, INTERVAL 1 MONTH) AND session.sim_dev = false)
	GROUP BY session.sim_major_version, sim_minor_version
) as last_month,
(
	SELECT DISTINCT session.sim_major_version AS sim_major_version, session.sim_minor_version AS sim_minor_version, COUNT(session.id) AS val
	FROM session, (
		SELECT id FROM sim_name WHERE name = 'pendulum-lab'
	) AS x
	WHERE (session.sim_name = x.id AND session.timestamp >= DATE_SUB(CURRENT_TIMESTAMP, INTERVAL 1 WEEK) AND session.sim_dev = false)
	GROUP BY session.sim_major_version, sim_minor_version
) as last_week,
(
	SELECT DISTINCT session.sim_major_version AS sim_major_version, session.sim_minor_version AS sim_minor_version, COUNT(session.id) AS val
	FROM session, (
		SELECT id FROM sim_name WHERE name = 'pendulum-lab'
	) AS x
	WHERE (session.sim_name = x.id AND session.timestamp >= DATE_SUB(CURRENT_TIMESTAMP, INTERVAL 1 DAY) AND session.sim_dev = false)
	GROUP BY session.sim_major_version, sim_minor_version
) as last_day
WHERE (
	totals.sim_major_version = last_year.sim_major_version
	AND last_year.sim_major_version = last_month.sim_major_version
	AND last_month.sim_major_version = last_week.sim_major_version
	AND last_week.sim_major_version = last_day.sim_major_version
	AND totals.sim_minor_version = last_year.sim_minor_version
	AND last_year.sim_minor_version = last_month.sim_minor_version
	AND last_month.sim_minor_version = last_week.sim_minor_version
	AND last_week.sim_minor_version = last_day.sim_minor_version
)
ORDER BY totals.sim_major_version, totals.sim_minor_version
;





SELECT CONCAT(totals.sim_major_version, '.', totals.sim_minor_version) AS version, totals.val AS total, last_year.val AS last_year, last_month.val AS last_month, last_week.val AS last_week, last_day.val AS last_day FROM ( SELECT DISTINCT session.sim_major_version AS sim_major_version, session.sim_minor_version AS sim_minor_version, COUNT(session.id) AS val FROM session, ( SELECT id FROM sim_name WHERE name = 'pendulum-lab' ) AS x WHERE (session.sim_name = x.id AND session.sim_dev = false) GROUP BY session.sim_major_version, sim_minor_version ) as totals, ( SELECT DISTINCT session.sim_major_version AS sim_major_version, session.sim_minor_version AS sim_minor_version, COUNT(session.id) AS val FROM session, ( SELECT id FROM sim_name WHERE name = 'pendulum-lab' ) AS x WHERE (session.sim_name = x.id AND session.timestamp >= DATE_SUB(CURRENT_TIMESTAMP, INTERVAL 1 YEAR) AND session.sim_dev = false) GROUP BY session.sim_major_version, sim_minor_version ) as last_year, ( SELECT DISTINCT session.sim_major_version AS sim_major_version, session.sim_minor_version AS sim_minor_version, COUNT(session.id) AS val FROM session, ( SELECT id FROM sim_name WHERE name = 'pendulum-lab' ) AS x WHERE (session.sim_name = x.id AND session.timestamp >= DATE_SUB(CURRENT_TIMESTAMP, INTERVAL 1 MONTH) AND session.sim_dev = false) GROUP BY session.sim_major_version, sim_minor_version ) as last_month, ( SELECT DISTINCT session.sim_major_version AS sim_major_version, session.sim_minor_version AS sim_minor_version, COUNT(session.id) AS val FROM session, ( SELECT id FROM sim_name WHERE name = 'pendulum-lab' ) AS x WHERE (session.sim_name = x.id AND session.timestamp >= DATE_SUB(CURRENT_TIMESTAMP, INTERVAL 1 WEEK) AND session.sim_dev = false) GROUP BY session.sim_major_version, sim_minor_version ) as last_week, ( SELECT DISTINCT session.sim_major_version AS sim_major_version, session.sim_minor_version AS sim_minor_version, COUNT(session.id) AS val FROM session, ( SELECT id FROM sim_name WHERE name = 'pendulum-lab' ) AS x WHERE (session.sim_name = x.id AND session.timestamp >= DATE_SUB(CURRENT_TIMESTAMP, INTERVAL 1 DAY) AND session.sim_dev = false) GROUP BY session.sim_major_version, sim_minor_version ) as last_day WHERE ( totals.sim_major_version = last_year.sim_major_version AND last_year.sim_major_version = last_month.sim_major_version AND last_month.sim_major_version = last_week.sim_major_version AND last_week.sim_major_version = last_day.sim_major_version AND totals.sim_minor_version = last_year.sim_minor_version AND last_year.sim_minor_version = last_month.sim_minor_version AND last_month.sim_minor_version = last_week.sim_minor_version AND last_week.sim_minor_version = last_day.sim_minor_version ) ORDER BY totals.sim_major_version, totals.sim_minor_version;










