<project name="General Ant Build Script" default="Publish Executables" basedir=".">

    <property file="build.properties"/>
    <property file="build.number"/>

    <!--  Set ant output directories.  -->
    <property name="ant.output" value="../ant_output"/>
    <property name="classes" location="${ant.output}/classes"/>
    <property name="jars" location="${ant.output}/jars"/>
    <property name="javadoc" location="${ant.output}/javadoc"/>
    <property name="lib" location="${ant.output}/lib"/>

    <!--    Set current sister directories, for backup and release data. -->
    <property name="development" location="../development"/>
    <property name="backup" location="../backup"/>
    <property name="releases" location="../releases"/>
    <property name="idea.classes" location="${development}/classes"/>

    <!--  Set up child directories, for during the build.  -->
    <property name="src" location="src"/>
    <property name="tests-src" location="tests-src"/>
    <property name="data" location="data"/>
    <property name="desktop" location="C:/Documents and Settings/Sam Reid/Desktop"></property>

    <description>
        Build File.
    </description>

    <target name="Clean Dependencies">
        <delete dir="${idea.classes}"></delete>
        <mkdir dir="${idea.classes}"></mkdir>
    </target>

    <target name="init">
        <tstamp/>
    </target>

    <target name="Backup Source" depends="init">
        <mkdir dir="${backup}"/>
        <tstamp>
            <format property="backup.time" pattern="d-MMMM-yyyy h-mmaa" locale="en" timezone="MST"></format>
        </tstamp>
        <mkdir dir="${backup}/${distname}_src_${backup.time}"/>
        <copy todir="${backup}/${distname}_src_${backup.time}">
            <fileset dir="${src}"/>
            <!--            <fileset dir="${tests-src}"/>-->
        </copy>
    </target>

    <target name="Backup Development" depends="init">
        <mkdir dir="${backup}"/>
        <tstamp>
            <format property="backup.time" pattern="d-MMMM-yyyy h-mmaa" locale="en" timezone="MST"></format>
        </tstamp>
        <mkdir dir="${backup}/${distname}_dev_${backup.time}"/>
        <copy todir="${backup}/${distname}_dev_${backup.time}">
            <fileset dir="${development}"/>
        </copy>
    </target>

    <target name="Backup Dev and Lib" depends="init">
        <mkdir dir="${backup}"/>
        <tstamp>
            <format property="backup.time" pattern="d-MMMM-yyyy h-mmaa" locale="en" timezone="MST"></format>
        </tstamp>
        <mkdir dir="${backup}/${distname}_dev_${backup.time}"/>
        <copy todir="${backup}/${distname}_dev_${backup.time}">
            <fileset dir="${development}"/>
        </copy>
        <copyclasspath directory="${backup}/${distname}_dev_${backup.time}/lib" ignore="${ignorepath}"/>
    </target>

    <target name="Backup Dev and Lib to desktop" depends="init">
        <mkdir dir="${desktop}"/>
        <tstamp>
            <format property="backup.time" pattern="d-MMMM-yyyy h-mmaa" locale="en" timezone="MST"></format>
        </tstamp>
        <mkdir dir="${desktop}/${distname}_dev_${backup.time}"/>
        <copy todir="${desktop}/${distname}_dev_${backup.time}">
            <fileset dir="${development}"/>
        </copy>
        <copyclasspath directory="${desktop}/${distname}_dev_${backup.time}/lib" ignore="${ignorepath}"/>
    </target>

    <target name="Clean"
        description="clean up">
        <delete dir="${classes}"/>
        <delete dir="${jars}"/>
        <delete dir="${javadoc}"/>
        <delete dir="${lib}"/>
    </target>

    <target name="Compile" depends="init"
        description="compile the source ">
        <delete dir="${classes}"/>
        <mkdir dir="${classes}"/>
        <javac srcdir="${src}" destdir="${classes}"/>
        <!--    Uncomment the following line to add test classes to the output jar.    -->
        <!--        <javac srcdir="${tests-src}" destdir="${classes}"/>-->
    </target>

    <target name="Synchronize Build meta info">
        <tstamp>
            <format property="jar.creation.time" pattern="d-MMMM-yyyy h:mm aa" locale="en" timezone="MST"></format>
        </tstamp>
        <echo file="build.time.stamp.txt" message="${jar.creation.time}"></echo>
        <copy file="build.time.stamp.txt" tofile="${data}/build.time.stamp.txt"></copy>
        <copy file="build.number" tofile="${data}/build.number"/>
    </target>


    <target name="Generate Jar" depends="Compile"
        description="generate the distribution">
        <!-- Create the distribution directory -->
        <delete dir="${jars}"/>
        <mkdir dir="${jars}"/>
        <buildnumber/>
        <tstamp>
            <format property="jar.creation.time" pattern="d-MMMM-yyyy h:mm aa" locale="en" timezone="MST"></format>
        </tstamp>
        <echo file="build.time.stamp.txt" message="${jar.creation.time}"></echo>
        <jar destfile="${jars}/${distname}.jar">
            <fileset dir="${classes}"/>
            <fileset dir="${data}"/>
            <fileset file="build.number"/>
            <fileset file="build.time.stamp.txt"/>
            <manifest>
                <attribute name="Built-By" value="${user.name}"/>
                <attribute name="version" value="${version}"/>
                <attribute name="build" value="${build.number}"/>
                <attribute name="Main-Class" value="${main.class}"/>
                <!--                <attribute name="time.stamp" value="${jar.creation.time}"/>-->
            </manifest>
        </jar>
    </target>

    <target name="Javadoc">
        <delete dir="${javadoc}"/>
        <javadoc destdir="${javadoc}" author="true" version="true" use="true">
            <packageset dir="src" defaultexcludes="yes">
            </packageset>
            <bottom><![CDATA[<i>Copyright &#169; 2003 Sam Reid. All Rights Reserved.</i>]]></bottom>
            <link href="http://java.sun.com/products/jdk/1.4/docs/api/"/>
        </javadoc>
    </target>

    <target name="Publish Library" depends="Generate Jar,Javadoc"
        description="generate the release distribution, including binary, source and docs">
        <mkdir dir="${releases}"/>
        <property name="destdir" value="${releases}/${distname}${version}_library-build-${build.number}"/>
        <mkdir dir="${destdir}"/>
        <mkdir dir="${destdir}/src"/>
        <mkdir dir="${destdir}/bin"/>
        <mkdir dir="${destdir}/javadoc"/>
        <mkdir dir="${destdir}/fullbackup-development"/>

        <copy todir="${destdir}/fullbackup-development">
            <fileset dir="${development}"/>
        </copy>

        <copy todir="${destdir}">
            <fileset dir="." casesensitive="yes">
                <include name="*.txt"/>
                <include name="*.xml"/>
                <include name="*.properties"/>
            </fileset>
        </copy>

        <copy todir="${destdir}/javadoc">
            <fileset dir="${javadoc}"></fileset>
        </copy>

        <copy todir="${destdir}/bin">
            <fileset dir="${jars}"/>
        </copy>

        <copy todir="${destdir}/src">
            <filterset>
                <filter token="ant_header" value="This file is part of ${projectname}.${line.separator}${line.separator}${projectname} is free software; you can redistribute it and/or modify${line.separator}it under the terms of the GNU General Public License as published by${line.separator}the Free Software Foundation; either version 2 of the License, or${line.separator}(at your option) any later version.${line.separator}${line.separator}${projectname} is distributed in the hope that it will be useful,${line.separator}but WITHOUT ANY WARRANTY; without even the implied warranty of${line.separator}MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the${line.separator}GNU General Public License for more details.${line.separator}${line.separator}You should have received a copy of the GNU General Public License${line.separator}along with Foobar; if not, write to the Free Software${line.separator}Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA${line.separator}${line.separator}Copyright ${user.name}, 2003"/>
            </filterset>
            <fileset dir="${src}"/>
        </copy>
        <copyclasspath directory="${destdir}/lib" ignore="${ignorepath}"/>
        <CreateBatchFile mainJar="bin/${distname}.jar" libDir="${destdir}/lib" mainClassName="${main.class}" outputFile="${destdir}/run_${distname}.bat"/>
    </target>

    <taskdef name="copyclasspath" classname="org.reids.anttasks.CopyClasspath"/>
    <taskdef name="createresourcetag" classname="org.reids.anttasks.CreateResourcesTag"/>
    <taskdef name="CreateBatchFile" classname="org.reids.anttasks.CreateBatchFile"/>

    <target name="Copy Classpath To lib">
        <delete dir="${lib}"/>
        <copyclasspath directory="${lib}" ignore="${ignorepath}"/>
        <createresourcetag mainJar="${distname}.jar" directory="${lib}" outputFile="resources.ant.output.txt"/>
        <CreateBatchFile mainJar="bin/${distname}.jar" libDir="${lib}" mainClassName="${main.class}" outputFile="run_${distname}.bat">
        </CreateBatchFile>
    </target>

    <target name="Output Classpath to File">
        <echo file="classpath.output.txt" message="${java.class.path}"></echo>
    </target>

    <target name="Publish Executables" depends="Generate Jar"
        description="generate executables, jar files, lib files, a batchfile">
        <mkdir dir="${releases}"/>
        <property name="destdir" value="${releases}/${distname}${version}_exec-build-${build.number}"/>
        <mkdir dir="${destdir}"/>
        <copy todir="${destdir}">
            <fileset dir="${jars}"/>
        </copy>
        <copy todir="${destdir}">
            <fileset dir="." casesensitive="yes">
                <include name="${distname}.jnlp"></include>
            </fileset>
        </copy>
        <copyclasspath directory="${destdir}/lib" ignore="${ignorepath}"/>
        <CreateBatchFile mainJar="${distname}.jar" libDir="${destdir}/lib" mainClassName="${main.class}" outputFile="${destdir}/run_${distname}.bat"/>
    </target>

    <target name="Open Explorer">
        <exec dir="${development}" executable="explorer">
            <arg line="${development}"></arg>
        </exec>
    </target>

    <!--    <taskdef name="ssh" classname="com.sshtools.ant.Ssh"/>-->
    <!--    <taskdef name="sftp" classname="com.sshtools.ant.Sftp"/>-->
    <!--    <target name="Test SSH Task">-->
    <!--        <ssh host="ucsub.colorado.edu"-->
    <!--            verifyhost="false"-->
    <!--            always="true"-->
    <!--            username="reids"-->
    <!--            password="xxxxx">-->
    <!--            <sftp action="put"-->
    <!--                depends="true"-->
    <!--                remotedir="/Net/www/webdata/htdocs/UCB/AcademicAffairs/ArtsSciences/physics/pion/phet/temp">-->
    <!--                <fileset dir="C:/test">-->
    <!--                    <include name="*.txt"></include>-->
    <!--                </fileset>-->
    <!--            </sftp>-->
    <!--        </ssh>-->
    <!--    </target>-->

    <!--    <taskdef resource="C:/Documents and Settings/Sam Reid/Desktop/GenJar/genjar.properties"/>-->
    <taskdef name="genjar" classname="org.apache.tools.ant.taskdefs.optional.genjar.GenJar"/>
    <target name="Use GenJar">
        <genjar jarfile="gen-out.jar">
            <class name="electron.shock.StaticElectricityNode"/>
        </genjar>
    </target>

</project>